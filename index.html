<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penjana Resit Wakaf Kg Baru Batu Tumbuh</title>
    <!-- Taildwind CSS untuk penggayaan -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas untuk fungsi muat turun gambar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font Awesome untuk ikon -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
        }
        .bg-custom {
            /* Dikemaskini kepada .jpeg untuk sepadan dengan fail di GitHub anda */
            background-image: linear-gradient(rgba(10, 40, 20, 0.85), rgba(10, 40, 20, 0.85)), url('image_450477.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-custom min-h-screen p-4 flex items-center justify-center">

    <!-- NOTIFIKASI TOAST -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 -translate-y-20 z-[100] transition-all duration-300 opacity-0 pointer-events-none w-[90%] max-w-md">
        <div id="toastContent" class="bg-gray-800 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center text-sm font-medium border-l-4 border-blue-500">
            <i id="toastIcon" class="fas fa-info-circle mr-3 text-lg"></i>
            <span id="toastMsg" class="leading-tight">Mesej</span>
        </div>
    </div>

    <!-- MODAL LOGIN ADMIN -->
    <div id="adminModal" class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-6 w-[90%] max-w-sm shadow-2xl transform scale-95 transition-transform duration-300" id="adminModalContent">
            <div class="text-center mb-5">
                <div class="inline-block bg-gray-100 p-3 rounded-full mb-2">
                    <i class="fas fa-lock text-2xl text-gray-700"></i>
                </div>
                <h3 class="font-bold text-xl text-gray-800">Panel Admin</h3>
                <p class="text-xs text-gray-500 mt-1">Sila masukkan kata laluan untuk akses.</p>
            </div>
            <input type="password" id="adminPassword" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 mb-5 bg-gray-50 text-center text-lg tracking-widest" placeholder="••••••••">
            
            <div class="flex space-x-3">
                <button onclick="closeAdminLogin()" class="w-1/2 py-3 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 font-semibold transition">Batal</button>
                <button onclick="submitAdminLogin()" class="w-1/2 py-3 bg-green-700 text-white rounded-xl hover:bg-green-800 font-semibold shadow-md transition">Masuk</button>
            </div>
        </div>
    </div>

    <!-- MODAL PENGESAHAN PADAM -->
    <div id="deleteModal" class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-6 w-[90%] max-w-sm shadow-2xl transform scale-95 transition-transform duration-300" id="deleteModalContent">
            <div class="text-center mb-5">
                <div class="inline-block bg-red-100 p-3 rounded-full mb-2">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h3 class="font-bold text-xl text-gray-800">Padam Rekod?</h3>
                <p class="text-sm text-gray-500 mt-2">Adakah anda pasti mahu memadam rekod sumbangan ini? Tindakan ini tidak boleh diundur.</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeDeleteModal()" class="w-1/2 py-3 text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 font-semibold transition">Batal</button>
                <button onclick="executeDelete()" class="w-1/2 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 font-semibold shadow-md transition">Ya, Padam</button>
            </div>
        </div>
    </div>

    <div id="mainContainer" class="max-w-md w-full mx-auto transition-all duration-300 relative z-10">
        
        <!-- BAHAGIAN 1: PAPARAN DEPAN (LANDING PAGE) -->
        <div id="landingSection" class="animate-fade-in">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-green-100">
                <!-- Dikemaskini kepada .jpeg -->
                <img src="image_450477.jpeg" alt="Poster Wakaf" class="w-full h-auto object-cover border-b-4 border-yellow-500">
                <div class="p-8 text-center">
                    <h2 class="text-xl font-bold text-green-800 mb-2 leading-tight">Sistem Penjana Resit Digital</h2>
                    <p class="text-gray-600 text-sm mb-6">Dana Pembelian Tanah Wakaf dan Pengurusan Kubur Kampung Baru Batu Tumbuh</p>
                    
                    <button onclick="enterApp()" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all transform hover:scale-[1.02] flex justify-center items-center">
                        <i class="fas fa-sign-in-alt mr-3"></i> Masuk ke Sistem
                    </button>
                </div>
            </div>
        </div>

        <!-- AMARAN MOD LUAR TALIAN -->
        <div id="offlineWarningBanner" class="hidden mb-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 rounded shadow-md text-xs leading-relaxed animate-fade-in">
            <i class="fas fa-exclamation-triangle mr-1"></i> <strong>Mod Luar Talian Aktif:</strong> Pangkalan data belum dikonfigurasi sepenuhnya. Rekod hanya disimpan sementara.
        </div>

        <!-- BAHAGIAN 2: BORANG (FORM) -->
        <div id="formSection" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden border border-green-100 animate-fade-in">
            <div class="bg-green-800 p-6 text-center">
                <h1 class="text-lg font-bold text-yellow-400 leading-tight">Dana Pembelian Tanah Wakaf<br>dan Pengurusan Kubur</h1>
                <p class="text-green-100 text-sm mt-2">Kampung Baru Batu Tumbuh</p>
            </div>
            
            <div class="p-6">
                <form id="receiptForm" onsubmit="generateReceipt(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="name">
                            <i class="fas fa-user mr-2 text-green-700"></i>Nama Penderma
                        </label>
                        <input type="text" id="name" required
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            placeholder="Contoh: Ahmad bin Abu">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="phone">
                            <i class="fas fa-phone mr-2 text-green-700"></i>No. Telefon Penderma
                        </label>
                        <input type="tel" id="phone" required
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            placeholder="Contoh: 0123456789">
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="amount">
                            <i class="fas fa-money-bill-wave mr-2 text-green-700"></i>Jumlah Sumbangan (RM)
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-gray-500 font-semibold">RM</span>
                            <input type="number" id="amount" step="0.01" min="1" required
                                class="w-full pl-10 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                placeholder="0.00">
                        </div>
                    </div>

                    <button type="submit" 
                        class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 flex justify-center items-center">
                        <i class="fas fa-file-invoice mr-2"></i> Jana Resit
                    </button>
                    
                    <button type="button" onclick="backToLanding()" class="w-full mt-4 text-gray-400 text-xs hover:text-gray-600 transition">
                        <i class="fas fa-arrow-left mr-1"></i> Kembali ke Muka Depan
                    </button>
                </form>
            </div>
        </div>

        <!-- BAHAGIAN 3: PAPARAN RESIT -->
        <div id="receiptSection" class="hidden animate-fade-in">
            <!-- Kad Resit -->
            <div id="receiptCard" class="bg-white rounded-lg shadow-2xl overflow-hidden border-2 border-green-800 relative">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5 pointer-events-none">
                    <i class="fas fa-mosque text-9xl"></i>
                </div>
                <div class="bg-green-800 text-center p-5 border-b-4 border-yellow-500">
                    <h2 class="text-lg font-bold text-yellow-400 uppercase leading-tight">Dana Pembelian Tanah Wakaf<br>dan Pengurusan Kubur</h2>
                    <h3 class="text-sm font-semibold text-white mt-2">Kampung Baru Batu Tumbuh</h3>
                </div>
                <div class="p-6 relative z-10">
                    <div class="text-center mb-6">
                        <span class="inline-block bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wider">Resit Rasmi</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-3 text-sm">
                        <span class="text-gray-500">No. Resit:</span>
                        <span class="font-bold text-gray-800" id="displayRefNo"></span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-3 text-sm">
                        <span class="text-gray-500">Tarikh & Masa:</span>
                        <span class="font-bold text-gray-800" id="displayDate"></span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-3 text-sm">
                        <span class="text-gray-500">Nama:</span>
                        <span class="font-bold text-gray-800 text-right w-2/3" id="displayName"></span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-6 text-sm">
                        <span class="text-gray-500">No. Telefon:</span>
                        <span class="font-bold text-gray-800" id="displayPhone"></span>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <span class="block text-sm text-gray-600 mb-1">Jumlah Diterima</span>
                        <span class="text-3xl font-bold text-green-800" id="displayAmount"></span>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-xs text-gray-500 italic">"Semoga Allah Membalas Jasa Baik Anda"</p>
                        <p class="text-[10px] text-gray-400 mt-2">Resit dijana berkomputer. Tiada tandatangan diperlukan.</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 space-y-3">
                <button onclick="sendWhatsApp()" class="w-full bg-[#25D366] hover:bg-[#1ebd5a] text-white font-bold py-3 px-4 rounded-lg shadow-md transition flex justify-center items-center">
                    <i class="fab fa-whatsapp text-xl mr-2"></i> WhatsApp Penderma
                </button>
                <div class="flex space-x-3">
                    <button onclick="downloadImage()" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition text-sm flex justify-center items-center">
                        <i class="fas fa-download mr-2"></i> Gambar
                    </button>
                    <button onclick="resetForm()" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition text-sm flex justify-center items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Resit Baru
                    </button>
                </div>
            </div>
        </div>

        <!-- FOOTER / KREDIT -->
        <div id="footerSection" class="mt-8 text-center text-xs text-white opacity-90 tracking-wide font-medium drop-shadow-md">
            Powered by <br>
            <span class="font-bold text-yellow-400 text-sm">Muiz Banner Empire</span>
            <div class="mt-4">
                <button onclick="openAdminLogin()" class="text-white/60 hover:text-white hover:underline transition text-[11px]"><i class="fas fa-lock mr-1"></i> Panel Admin</button>
            </div>
        </div>

        <!-- BAHAGIAN ADMIN -->
        <div id="adminSection" class="hidden bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 mt-4 relative z-10 animate-fade-in">
            <div class="bg-gray-800 p-5 flex justify-between items-center">
                <h1 class="text-lg font-bold text-white"><i class="fas fa-user-shield text-yellow-400 mr-2"></i>Rekod Sumbangan</h1>
                <button onclick="closeAdmin()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-x-auto">
                <div class="flex flex-col md:flex-row justify-between md:items-end mb-4 bg-gray-50 p-4 rounded-lg border gap-4">
                    <div>
                        <p class="text-sm text-gray-500 mb-1">Jumlah Kutipan Terkumpul</p>
                        <p class="text-3xl font-bold text-green-700" id="adminTotalAmount">RM 0.00</p>
                    </div>
                    <div class="md:text-right">
                        <p class="text-sm text-gray-500 mb-1">Jumlah Transaksi</p>
                        <p class="text-xl font-bold text-gray-800" id="adminTotalCount">0</p>
                    </div>
                </div>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-5" id="offlineAdminWarning" style="display: none;">
                    <p class="text-xs text-yellow-800 leading-relaxed">Mod Luar Talian Aktif. Rekod hanya disimpan sementara.</p>
                </div>
                <div class="min-w-[600px]">
                    <table class="w-full text-left border-collapse text-sm">
                        <thead>
                            <tr class="bg-green-100 text-green-800 border-b-2 border-green-200">
                                <th class="p-3">No. Resit</th>
                                <th class="p-3">Tarikh</th>
                                <th class="p-3">Nama</th>
                                <th class="p-3">Telefon</th>
                                <th class="p-3 text-right">RM</th>
                                <th class="p-3 text-center">Batal</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody"></tbody>
                    </table>
                </div>
                <div id="emptyDataMsg" class="text-center py-10 text-gray-400 hidden">Tiada rekod setakat ini.</div>
            </div>
        </div>
    </div>

    <!-- SKRIP UTAMA & FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnfe1OK_P5oG0aUqz0n8BqtgYo4ALfK-8",
            authDomain: "dana-tanah-kubur.firebaseapp.com",
            projectId: "dana-tanah-kubur",
            storageBucket: "dana-tanah-kubur.firebasestorage.app",
            messagingSenderId: "993200619810",
            appId: "1:993200619810:web:27a570326d8a21fad6e57b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const customAppId = "dana-tanah-kubur";

        let currentUser = null;
        let receiptsData = []; 
        let isOfflineMode = false;
        let recordToDeleteId = null;

        // --- NAVIGASI ---
        window.enterApp = function() {
            document.getElementById('landingSection').classList.add('hidden');
            document.getElementById('formSection').classList.remove('hidden');
        }

        window.backToLanding = function() {
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('landingSection').classList.remove('hidden');
        }

        // --- AUTH ---
        async function initAuth() {
            try { await signInAnonymously(auth); } 
            catch (e) { 
                isOfflineMode = true; 
                document.getElementById('offlineWarningBanner').classList.remove('hidden');
            }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                isOfflineMode = false;
                setupRealtimeListener(); 
            }
        });

        function setupRealtimeListener() {
            if (!currentUser || isOfflineMode) return;
            const colRef = collection(db, 'artifacts', customAppId, 'public', 'data', 'receipts');
            onSnapshot(colRef, (snapshot) => {
                receiptsData = [];
                snapshot.forEach(doc => { receiptsData.push({ id: doc.id, ...doc.data() }); });
                receiptsData.sort((a, b) => b.timestamp - a.timestamp);
                if (!document.getElementById('adminSection').classList.contains('hidden')) renderAdminTable();
            });
        }

        // --- UTILITI ---
        window.formatDate = (date) => date.toLocaleString('ms-MY', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
        window.generateRefNo = () => `WKF-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(1000 + Math.random() * 9000)}`;

        window.generateReceipt = async function(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            try {
                const data = {
                    refNo: window.generateRefNo(),
                    date: window.formatDate(new Date()),
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    amount: parseFloat(document.getElementById('amount').value).toFixed(2),
                    timestamp: Date.now()
                };

                if (!isOfflineMode) {
                    await addDoc(collection(db, 'artifacts', customAppId, 'public', 'data', 'receipts'), data);
                } else {
                    receiptsData.unshift({ id: 'local_'+data.timestamp, ...data });
                }

                document.getElementById('displayRefNo').textContent = data.refNo;
                document.getElementById('displayDate').textContent = data.date;
                document.getElementById('displayName').textContent = data.name;
                document.getElementById('displayPhone').textContent = data.phone;
                document.getElementById('displayAmount').textContent = 'RM ' + data.amount;

                document.getElementById('formSection').classList.add('hidden');
                document.getElementById('receiptSection').classList.remove('hidden');
                window.showToast("Berjaya dijana!", "success");
            } catch (e) { window.showToast("Ralat menyimpan!", "error"); }
            btn.disabled = false;
        }

        window.sendWhatsApp = () => {
            const name = document.getElementById('displayName').textContent;
            let phone = document.getElementById('displayPhone').textContent.replace(/\s+/g, '');
            phone = phone.startsWith('0') ? '6' + phone : (phone.startsWith('6') ? phone : '60' + phone);
            const msg = `*RESIT SUMBANGAN RASMI*\nDana Tanah Wakaf Kg Baru Batu Tumbuh\n\nNo: *${document.getElementById('displayRefNo').textContent}*\nNama: ${name}\nJumlah: *${document.getElementById('displayAmount').textContent}*\n\nTerima kasih.`;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        window.downloadImage = () => {
            html2canvas(document.getElementById('receiptCard'), { scale: 2 }).then(canvas => {
                const a = document.createElement('a');
                a.download = `Resit_${document.getElementById('displayRefNo').textContent}.png`;
                a.href = canvas.toDataURL();
                a.click();
            });
        }

        window.resetForm = () => {
            document.getElementById('receiptForm').reset();
            document.getElementById('receiptSection').classList.add('hidden');
            document.getElementById('formSection').classList.remove('hidden');
        }

        // --- ADMIN ---
        window.openAdminLogin = () => {
            document.getElementById('adminModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('adminModal').classList.remove('opacity-0'), 10);
        }
        window.closeAdminLogin = () => {
            document.getElementById('adminModal').classList.add('opacity-0');
            setTimeout(() => document.getElementById('adminModal').classList.add('hidden'), 300);
        }
        window.submitAdminLogin = () => {
            if (document.getElementById('adminPassword').value === "kubur123") {
                window.closeAdminLogin();
                document.getElementById('formSection').classList.add('hidden');
                document.getElementById('landingSection').classList.add('hidden');
                document.getElementById('mainContainer').className = "max-w-4xl w-full mx-auto transition-all duration-300 relative z-10";
                document.getElementById('adminSection').classList.remove('hidden');
                renderAdminTable();
            } else window.showToast("Salah!", "error");
        }
        window.closeAdmin = () => {
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('mainContainer').className = "max-w-md w-full mx-auto transition-all duration-300 relative z-10";
            document.getElementById('formSection').classList.remove('hidden');
        }
        window.renderAdminTable = () => {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            let total = 0;
            receiptsData.forEach(d => {
                tbody.innerHTML += `<tr class="border-b text-xs md:text-sm">
                    <td class="p-3">${d.refNo}</td>
                    <td class="p-3">${d.date}</td>
                    <td class="p-3 font-bold">${d.name}</td>
                    <td class="p-3">${d.phone}</td>
                    <td class="p-3 text-right font-bold text-green-700">RM${d.amount}</td>
                    <td class="p-3 text-center"><button onclick="confirmDelete('${d.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`;
                total += parseFloat(d.amount);
            });
            document.getElementById('adminTotalAmount').textContent = 'RM ' + total.toFixed(2);
            document.getElementById('adminTotalCount').textContent = receiptsData.length;
        }

        window.confirmDelete = (id) => {
            recordToDeleteId = id;
            document.getElementById('deleteModal').classList.remove('hidden', 'opacity-0');
        }
        window.closeDeleteModal = () => document.getElementById('deleteModal').classList.add('hidden', 'opacity-0');
        window.executeDelete = async () => {
            if (recordToDeleteId.startsWith('local_')) receiptsData = receiptsData.filter(i => i.id !== recordToDeleteId);
            else await deleteDoc(doc(db, 'artifacts', customAppId, 'public', 'data', 'receipts', recordToDeleteId));
            renderAdminTable();
            window.closeDeleteModal();
            window.showToast("Dipadam!", "success");
        }

        window.showToast = (msg, type) => {
            document.getElementById('toastMsg').textContent = msg;
            document.getElementById('toast').classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => document.getElementById('toast').classList.add('-translate-y-20', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
